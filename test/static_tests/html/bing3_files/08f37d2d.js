(function(){var g,a,i,p,v,k,w,u,nt,rt,c,ut,ft;try{var f=window.$MicrosoftMaps8,t=f.Internal,wt=f.Anchor,ot=t.CanvasDrawingContext,l=t._CanvasLabelRenderer,tt=t._Color,st=f.CoordinateProjection,e=t._Debug,ht=t._EntityHelper,o=f.GlobalConfig,s=t._Gimme,n=t._Helper,bt=t._IconLabel,kt=t.HitTestIndex,dt=t._LabelData,gt=o.features.labels,ct=t._LruCache,ni=f.Matrix2D,lt=t._NAARectangle,ti=t._Observable,h=f.Point,at=f.Rectangle,ii=t.RelativePlacement,it=f.Size,ri=f.Viewport,ui=f.ZoomLevel,vt=f.VectorImageTemplate,fi=f.VectorMapLayer,r=t._VectorMath,ei=t._WorkDispatcher,oi=t._LayerRendererManager,si=t.LabelRenderer,yt=t.LabelController,pt=t.VectorLabels,y=t._VectorLayerRenderer,b=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),d=function(t){function i(n,i,r,u,f){var e=t.call(this,n,i,r,u,f)||this;return s.Browser.is_safari&&s(window).add_event("pagehide",function(){e.dispose()}),e}return b(i,t),i.prototype.transformContainer=function(i){var r=t.prototype.transformContainer.call(this,i);return n._renderAllPoiAndLabelsGL()&&this._adapter&&this._adapter.render(this._map,null,null,null,0,!0,n._getDpr(),0),r},i.prototype.copyCanvas=function(n){var i,r;t.prototype.copyCanvas.call(this,n);i=this._adapter;i&&(i.draw(this._map),r=i.getCanvas()[0],n.drawImage(r,0,0,r.width,r.height))},i.prototype.dispose=function(){t.prototype.dispose.call(this);this._canvasGL&&this._canvasGL.removeFromParent();n._clearDisposables([this._adapter,this._frameLoadedHandler]);n._nullifyClass(this)},i.prototype._positionCanvas=function(r,u){var f=this,e=t.prototype._positionCanvas.call(this,r),h=this._renderEntityTypes.indexOf(1)>-1,c,l,a;return r||(c=this._adapter,l=n._renderAllPoiAndLabelsGL(),c?l&&c.updateSize(e):i._adapterFailed||(a=function(){f._appendCanvas();try{var r=h?2048:256,t=o.features.labels;f._adapter=new nt(f._canvasGL,e,r,!1,t.allowSoftwareGL,s.Browser.is_safari,t.preserveGLBuffer);i._adapterFailed=!1}catch(u){console.warn(u);n._disableRenderGL();i._adapterFailed=!0}},l&&(h||u)?a():this._frameLoadedHandler||h&&(this._frameLoadedHandler=this._map.getFrameManager().frameRendered.addOne(a)))),e},i.prototype._drawLabels=function(r,u,f){var s,it,c,a,v,rt,y,h,g,o,ft;if(n._renderAllPoiAndLabelsGL()){var nt=i._dataUpdateLevel(u,f),p=this._orderedLabels,w=l._getSortedPriorityKeys(Object.keys(p)),tt={},b=[];for(e.clearTestHooksLog(e.LabelDrawOrderTag),s=0,it=w.length;s<it;s++){if(c=p[w[s]],a=Object.keys(c),!a.length){delete p[w[s]];continue}for(v=0,rt=a.length;v<rt;v++){var ut=a[v],k=c[ut],d=Object.keys(k);if(d.length)for(y=d.length-1;y>=0;y--)(h=d[y],r||nt!==0||(g=k[h],o=g&&g.region,!o||o.type!==1||(ft=o&&o.label&&o.label.data&&o.label.data.primitives&&o.label.data.primitives[0],ft.taintedTemplate||!n._renderAllPoiAndLabelsGL())))&&(tt[h]=k[h],b.unshift(h));else delete c[ut]}}b.length>0?(this._positionCanvas(u,!0),this._drawLabelsInLayerGL(tt,b,r,u,this._drawingContext,this._dpiScale,f,nt)):this._adapter&&this._adapter.clear()}else t.prototype._drawLabels.call(this,r,u,f),this._adapter&&this._adapter.clear()},i.prototype._appendCanvas=function(){var i=this,t;this._canvasGL||(t=this._canvasGL=n._createElement("canvas"),t.set_attr("id",this._canvasId),t.set_attr("class","labelCanvas"),t.set_style({outline:"none",position:"absolute",zIndex:this._canvasZIndex}),this._map.getMode().getRootElement().append(t),s(t).add_event("webglcontextlost",function(n){i._handleRenderFailure(n)},!1))},i.prototype._handleRenderFailure=function(r){console.warn(r);n._disableRenderGL();i._adapterFailed=!0;this._adapter.dispose();this._adapter=null;t.prototype.endDraw.call(this,this._currentLabelRenderingContext,this._isAnimationFrame)},i.prototype._drawLabelsInLayerGL=function(i,r,u,f,o,s,h,c){var w,l,y,a,v,nt,b;this._isAnimationFrame=f;var k=0,d=[],g=o?o.getDevicePixelRatio():n._getDpr(),p,tt=this._adapter&&n._renderAllPoiAndLabelsGL();for(w=r.length-1;w>=0;w--)if(l=i[r[w]],e.logLabelDrawOrder(l.text),y=l.region,a=y.label.data.primitives[0],p=null,v=l.iconTemplates,!u||(nt=v&&v[0],b=ht.getClickable(a&&a.entity),b||(b=nt&&nt.getIsHitTestable()),b&&a&&a.layer)){if(y.type===1){if(!v||!v.length)continue;e.logPoiLayerStyleStart();u?this._renderHitTesting(v,a,l,y):p=this._renderTemplates(o,g,v,a,l,s,y,c);e.logPoiLayerStyleEnd(e.UserLogTag);e.logPushpinPrimitive(e.UserLogTag,a)}else l.style&&(tt?k+=this._drawTextLabelGL(l,g,u,f,d):t.prototype._drawTextLabel.call(this,l,u,f));p&&(d.push(p),p.cached||k++);t.prototype._renderDebugLabelBoundaries.call(this,u,y,o,s)}if(!u&&this._adapter)try{this._adapter.render(this._map,h,d,null,k,f,g,c)}catch(it){this._handleRenderFailure(it)}},i.prototype._renderTemplates=function(i,r,u,f,e,o,s,h){var c,v=this._adapter&&!f.taintedTemplate&&n._renderAllPoiAndLabelsGL(),l=s.anchor.x*o,a=s.anchor.y*o;return v?h!==0&&(c=p.packGLTemplates(i,this._adapter,r,u,f,e,o,l,a)):(f.taintedTemplate&&(this._taintedTemplatesExists=!0,t.prototype._validate2DCanvas.call(this)),p.renderCanvasTemplates(i,u,f,e,o,l,a)),c},i.prototype._drawTextLabelGL=function(r,u,f,e,o){for(var s,y,p,a=this._adapter&&this._adapter.currentData&&this._adapter.currentData.atlas.records,h,c,w=t.prototype._getTextLabelData.call(this,r,f,e,u),b=0,k=r.region.anchor,v=0,d=w.labels.length;v<d;v++)if(s=w.labels[v],s.text.trim().length!==0){c=s.text+s.font+s.style.styleDynamic.fontColor+s.rotation+s.outlineColor+s.outlineSize+s.relativePlacement+s.horizontalAlignment;y=a&&a.getItem(c);y?(h=n._copyObject(y),h.cached=!0):h=i._constructTextRecord(s,u,c);p=0;switch(s.horizontalAlignment){case 2:p=-l._hintLabelPadding*u}h.left=(s.x+s.anchorOffetX+h.adjustX+p)/u;h.top=(s.y+s.anchorOffetY+h.adjustY)/u;h.anchor=k;h.cached||(a.addItem(c,h),b++);h.visibleZoom=0;o.push(h)}return b},i._dataUpdateLevel=function(t,i){var r;if(i)if(t)r=n._renderAllPoiAndLabelsGL()?3:0;else switch(i.cause){case 7:r=0;break;case 3:r=2;default:r=4}else r=0;return r},i._constructTextRecord=function(n,t,r){var f,u,o=0,h=0,c=n.rotation,y,s,p;if(n.w*=t,n.h*=t,c===0)f=n.w,u=n.h;else{var w=at.fromPoints({x:0,y:0},{x:n.w,y:n.h}),a=new lt(w,c).bbox,e=a.minPoint,v=a.maxPoint;f=v.x-e.x;u=v.y-e.y;o=-e.x;h=-e.y}return y=l._getVerticalAdjustment(n.relativePlacement).verticalAdjustmentRatio*u,f=Math.ceil(f),f+=f%2,u=Math.ceil(u),u+=u%2,s=h+y,p=function(t,r,u){i._drawText(t,n,n.textBaseline,r+o,u+s)},{width:f,height:u,id:r,left:0,top:0,visibleZoom:0,adjustX:-o,adjustY:-s,renderLabel:p,atlasX:-1,atlasY:-1}},i._drawText=function(n,t,i,r,u){var f=n.getRawContext();switch(t.horizontalAlignment){default:case 1:f.textAlign="left";break;case 0:f.textAlign="center";r+=t.w/2;break;case 2:f.textAlign="right";r+=t.w}f.textBaseline=i;f.font=t.font;t.rotation!==0||t.resetFont?(n.save(),f.translate(r,u),f.rotate(t.rotation),l._strokeAndFillText(f,t.style,t.text,0,0,!1,t.glowColor,t.glowSize,t.outlineColor,t.outlineSize),n.restore(t.resetFont)):l._strokeAndFillText(f,t.style,t.text,r,u,!1,t.glowColor,t.glowSize,t.outlineColor,t.outlineSize)},i}(l);d.init();g=function(){function t(n,t,i,r,u){this.updateData(n,t,i,r,u)}return t.prototype.updateData=function(t,i,r,u,f){var e,o,s,h;this._gl=t;e=r.width>1?r.width:1;e=e>999?999:e;this._attributes=n._copyObject(r);this._attributes.width=e;o=t.canvas.width/2;s=t.canvas.height/2;e===1?this._lineStrip=a.generateBufferData(a.cleanData(i),o,s,u,f):e>=2&&(h=a.getTriangleStrip(i,r),this._innerTriangles=a.generateBufferData(h,o,s,u,f))},t.prototype.render=function(n,i){var r=this._gl;this._lineStrip?((!this._lineStripBuffer||i)&&(this._lineStripBuffer=t._upsertBuffer(r,this._lineStripBuffer,this._lineStrip)),t._renderPass(r,n,r.LINE_STRIP,this._lineStripBuffer,this._attributes.color,4,this._lineStrip.length/4)):((!this._innerBuffer||i)&&(this._innerBuffer=t._upsertBuffer(r,this._innerBuffer,this._innerTriangles)),t._renderPass(r,n,r.TRIANGLE_STRIP,this._innerBuffer,this._attributes.color,4,this._innerTriangles.length/4))},t.prototype.dispose=function(){this._gl&&(this._innerBuffer&&this._gl.deleteBuffer(this._innerBuffer),this._lineStripBuffer&&this._gl.deleteBuffer(this._lineStripBuffer));this._gl=this._lineStripBuffer=this._innerBuffer=this._innerTriangles=this._lineStrip=null},t._upsertBuffer=function(n,t,i){return i&&i.length>0&&(t||(t=n.createBuffer()),n.bindBuffer(n.ARRAY_BUFFER,t),n.bufferData(n.ARRAY_BUFFER,i,n.STATIC_DRAW)),t},t._renderPass=function(n,t,i,r,u,f,e){r&&(n.enableVertexAttribArray(t.a_position),n.bindBuffer(n.ARRAY_BUFFER,r),n.vertexAttribPointer(t.a_position,f,n.FLOAT,!1,0,0),n.uniform4f(t.u_color,u[0],u[1],u[2],u[3]),n.drawArrays(i,0,e))},t}(),function(n){function f(n,i){var f=u(n),l=f.length,e=[],y,g,k;if(l>1&&i.width>1&&i.width<999){var w=i.cap||"round",tt=i.join||"round",it=i.miterLimit||10,d=i.width/2,a=[],b=!0,p=i.cullface,c;if(l===2)h.pointsEqual(f[0],f[1])||e.push.apply(e,o(w,f[0],f[1],d,p));else{for(h.pointsEqual(f[0],f[l-1])&&(g=f.shift(),k=r.getMidpoint2D(g,f[0]),f.unshift(k),f.push(k),b=!1),l=f.length,c=0;c<l-1;c++)c===0?a.push(f[0]):c===l-2?a.push(f[l-1]):a.push(r.getMidpoint2D(f[c],f[c+1]));for(l=a.length,c=1;c<l;c++){var nt=c===1,rt=c===l-1,v=r.rotatingDirection(a[c-1],f[c],a[c])!==2;y=s(a[c-1],f[c],a[c],v,d,tt,it,nt,rt,p);b&&nt&&(v?e.push.apply(e,t(w,f[0],y[1]["export"](),y[0]["export"](),v,p)):e.push.apply(e,t(w,f[0],y[0]["export"](),y[1]["export"](),v,p)));e.push.apply(e,y)}l=e.length;b&&(v?e.push.apply(e,t(w,f[f.length-1],e[l-2]["export"](),e[l-1]["export"](),v,p)):e.push.apply(e,t(w,f[f.length-1],e[l-1]["export"](),e[l-2]["export"](),v,p)))}}return e}function u(n){var t=[],i,r;if(n&&n.length>0)for(i=0;i<n.length;i++)r=n[i],r&&!h.pointsEqual(r,t[t.length-1])&&t.push(r);return t}function e(n,t,r,u,f){for(var o=[],s=f.pixelScale,e=0;e<n.length;e++){var h=n[e]instanceof i,c=h?n[e].anchor:n[e],l=(c.x*u-t)/s,a=(r-c.y*u)/s;o.push(l);o.push(a);h?(o.push(n[e].offsetX*u),o.push(-n[e].offsetY*u)):o.push(0,0)}return new Float32Array(o)}function o(n,u,f,e,o){var h,c,s;if(u&&f){u.x>f.x&&(c=u,u=f,f=c);s=f.subtract(u);s=r.perpendicular2D(s).invert();s=r.normalizeVector2D(s).scalarMultiply(e);var l=new i(u,s.x,s.y),a=new i(u,-s.x,-s.y),v=new i(f,s.x,s.y),y=new i(f,-s.x,-s.y),p=[l,a,v,y];h=[];h.push.apply(h,t(n,u,a["export"](),l["export"](),!0,o));h.push.apply(h,p);h.push.apply(h,t(n,f,v["export"](),y["export"](),!0,o))}return h}function s(n,t,u,f,e,o,s,h,v,y){var b=[],p=t.subtract(n),st=r.getMagnitudeOfVector2D(p),w=u.subtract(t),ht=r.getMagnitudeOfVector2D(w),et,ot,it,rt;p=r.perpendicular2D(p);w=r.perpendicular2D(w);f&&(p=p.invert(),w=w.invert());p=r.normalizeVector2D(p).scalarMultiply(e);w=r.normalizeVector2D(w).scalarMultiply(e);var ut=new i(n,p.x,p.y),g=new i(t,p.x,p.y),ft=new i(u,w.x,w.y),nt=new i(t,w.x,w.y),tt=r.intersect2D(ut["export"](),g["export"](),ft["export"](),nt["export"]()),k,d=Number.MAX_VALUE;return tt&&(k=tt.subtract(t),d=r.getMagnitudeOfVector2D(k)),et=new i(n,-p.x,-p.y),ot=new i(u,-w.x,-w.y),d>st||d>ht?(it=new i(t,-p.x,-p.y),rt=new i(t,-w.x,-w.y)):it=rt=new i(t,-k.x,-k.y),b.push.apply(b,c(f,h,ut,et,g,it)),b.push.apply(b,a(o,t,g["export"](),nt["export"](),d,e,s,tt,f,y)),b.push.apply(b,l(f,v,nt,rt,ft,ot)),b}function c(n,t,i,r,u,f){var e=[];return n?(t&&(e.push(i),e.push(r)),e.push(u),e.push(f)):(t&&(e.push(r),e.push(i)),e.push(f),e.push(u)),e}function l(n,t,i,r,u,f){var e=[];return n?(e.push(i),e.push(r),t&&(e.push(u),e.push(f))):(e.push(r),e.push(u),t&&(e.push(f),e.push(u))),e}function t(n,t,i,r,u,f){var e;return n==="round"&&(e=k.sector(t,i,r,u,f)),e}function a(n,t,r,u,f,e,o,s,h,c){var l,p,a,v,y;return n==="round"?l=k.sector(t,r,u,h,c):(p=f/e,n==="bevel"||n==="miter"&&p>=o||!s?h||(a=r.subtract(u),l=[new i(t,0,0),new i(r,-a.x,-a.y)]):(v=r.subtract(s),y=new i(r,-v.x,-v.y),l=[y,y])),l}n.getTriangleStrip=f;n.cleanData=u;n.generateBufferData=e}(a||(a={}));i=function(){function n(n,t,i){this.anchor=n;this.offsetX=t;this.offsetY=i}return n.prototype["export"]=function(){return new h(this.anchor.x+this.offsetX,this.anchor.y+this.offsetY)},n}(),function(t){function i(i,r,o,s,h,c,l,a,v){var y,lt=c?c.text:"",k=u(s,lt,o),rt=r&&r.currentData&&r.currentData.atlas.records,ut=0,ft=0,et=0,ot=0,at=rt&&rt.getItem(k),w,p,b,vt,yt,d,nt,tt,st,ht,it,ct;if(at)y=n._copyObject(at),y.cached=!0;else{for(p=[],b=0,vt=s.length;b<vt;b++){if(yt=s[b],yt.tainted){h.taintedTemplate=!0;t.renderCanvasTemplates(i,s,h,c,l,a,v);p=null;break}if(w=s[b].renderData(o,{id:null,name:lt},0,0,l,e.UserLogTag,h),w&&w.resultImages&&w.resultImages.length>0){for(d=0;d<w.resultImages.length;d++){var g=w.resultImages[d],pt=g.drawX*o,wt=g.drawY*o;ut=Math.min(ut,pt);ft=Math.min(ft,wt);et=Math.max(et,pt+g.width);ot=Math.max(ot,wt+g.height)}p.push(w)}}nt=et-ut;tt=ot-ft;nt+=nt%2;tt+=tt%2;p.length===1&&p[0].resultImages.length===1?(st=p[0].resultImages[0].anchorAdjustX,ht=p[0].resultImages[0].anchorAdjustY):(it=c.region.anchor,ct=c.region.bounds.bbox.getCenter(),st=ct.x-it.x,ht=ct.y-it.y);y={width:nt,height:tt,id:k,left:0,top:0,visibleZoom:0,adjustX:Math.ceil(st),adjustY:Math.ceil(ht),templateResults:p,atlasX:-1,atlasY:-1}}return y.left=a-y.width/2/o+y.adjustX,y.top=v-y.height/2/o+y.adjustY,y.id=k,y.anchor=it,y.cached||rt.addItem(k,y),y.visibleZoom=f(h.visibilities),y}function r(n,t,i,r,u,f,o){for(var s=0,h=t.length;s<h;s++)t[s].renderCanvas(n,{id:null,name:r.text},f,o,u,e.UserLogTag,i)}function u(n,t,i){for(var r,u=[],f=!1,e=0;e<n.length;e++)r=n[e],!f&&r instanceof vt&&r.hasText&&(f=!0),r.id&&u.push(r.id+r.getScale());return(f?u.join()+t:u.join())+i}function f(n){var i=-1,t;if(n)for(i=0,t=0;t<n.length;t++)if(n[t].visible){i=n[t].zoom;break}return i}t.packGLTemplates=i;t.renderCanvasTemplates=r}(p||(p={})),function(n){var t="precision mediump float;";n.textureVertex=t+"\n            attribute vec4 a_position;\n            attribute vec2 a_texCoord;\n            attribute float a_visibleZoom;\n\n            uniform mat4 u_PTMatrix;\n            uniform vec2 u_halfScreen;\n            uniform float u_extrusionScale;\n            uniform int u_zoom;\n\n            varying vec2 v_texCoord;\n\n            void main() {\n                vec4 clipPosition= u_PTMatrix * vec4(a_position.xy, 0, 1);\n                float visibilityFlag = (float(u_zoom) < a_visibleZoom) ? 0.0: 1.0;\n                vec2 clipSpaceExtrusion = a_position.zw / u_halfScreen * clipPosition.w * u_extrusionScale * visibilityFlag;\n                vec4 afterExtrusion = vec4(clipPosition.xy+clipSpaceExtrusion, clipPosition.z, clipPosition.w);\n                gl_Position = vec4(afterExtrusion.xy , clipPosition.z, clipPosition.w);\n\n                /* pass the texCoord to the fragment shader */\n                v_texCoord = a_texCoord;\n            }";n.textureFragment=t+"\n            /* our texture */\n            uniform sampler2D u_image;\n\n            /* the texCoords passed in from the vertex shader. */\n            varying vec2 v_texCoord;\n\n            void main() {\n            gl_FragColor = texture2D(u_image, v_texCoord);\n            }";n.solidColorVertex=t+"\n        attribute vec4 a_position;\n\n        uniform mat4 u_PTMatrix;\n        uniform vec2 u_halfScreen;\n        uniform vec4 u_color;\n\n        varying vec4 col;\n\n        void main() {\n            col = u_color;\n\n            vec4 clipPosition= u_PTMatrix * vec4(a_position.xy, 0, 1);\n            vec2 clipSpaceExtrusion = a_position.zw / u_halfScreen * clipPosition.w;\n        \n            vec4 afterExtrusion = vec4(clipPosition.xy+clipSpaceExtrusion, clipPosition.z, clipPosition.w);\n            gl_Position = vec4(afterExtrusion.xy , clipPosition.z, clipPosition.w);\n        }";n.solidColorFragment=t+"\n          varying vec4 col;\n           void main() {\n           gl_FragColor = col;\n        }"}(v||(v={})),function(n){function t(n,t,i,f,e){var o=r.twoPI;return o=-r.getAngleBetween(n,t,i),f?o>0&&(o-=r.twoPI):o<0&&(o=o+r.twoPI),u(n,t,o,f,e)}function u(n,t,u,f,e){var c=r.getMagnitudeOfVector2D(n.subtract(t)),s=[],h=Math.ceil(Math.abs(u*c)/4),p=-r.getAngleOfSegment2D(n,t),y,l,o,a,v;for(h+=h%2,y=u/h,l=new i(n,0,0),o=0;o<=h;o++)a=p+y*o,v=new i(n,c*Math.cos(a),-c*Math.sin(a)),f?(s.push(v),(e||o%2==0)&&s.push(l)):((e||o%2==0)&&s.push(l),s.push(v));return s}n.sector=t}(k||(k={})),function(n){function i(n,t,i,u){var l=n.records,s=[],a=Object.keys(l.getInternalDictionary()),e=n.state,h,v,o,c;for(e||(n.state=e={lastAllocatedIndex:-1,lastRowHeight:0,resumePoint:{x:0,y:0},size:new it(t/2,t*2)}),h=0,v=a.length;h<v;h++)o=l.getItem(a[h]),o.cached&&o.atlasX!==-1&&o.atlasY!==-1||s.push(o);return e=n.state=f(s,e,1),c=e.lastAllocatedIndex===s.length-1,c&&!u&&e.updatedArea.w>0&&e.updatedArea.h>0&&r(n,s,i),c}function r(n,t,i){var r=n.context,f=n.state,o=f.size,l,e;if(r){var s=f.updatedArea.w,h=f.updatedArea.h,c=r.getSize();c.width===s&&c.height===h?r.clear():r.setSize(s,h)}else r=new ot(null,null,1),r.setSize(o.width,o.height);for(n.context=r,l=t.length,e=0;e<l;e++)u(r,t[e],f.updatedArea.y,i)}function u(n,t,i,r){var e=t.templateResults,h,c,l,f,o;if(e&&(h=e.length)>0&&t.width>0&&t.height>0)for(c=t.atlasX+t.width/2,l=t.atlasY-i+t.height/2,f=0;f<h;f++)for(o=0;o<e[f].resultImages.length;o++){var u=e[f].resultImages[o],a=r*(u.drawX-t.adjustX)+c,v=r*(u.drawY-t.adjustY)+l,s;u.shadow&&(s=n.getStyle(),n.setStyle(u.shadow));n.drawImage(u.source,a,v,u.width,u.height);s&&n.setStyle(s)}else t.renderLabel&&t.renderLabel(n,t.atlasX,t.atlasY-i)}function f(n,i,r){function g(){var n;return o+u.height+r>w?n=!1:(o+=s+r,s=0,f=0,n=!0),n}var f=i.resumePoint.x,o=i.resumePoint.y,s=i.lastRowHeight,p=i.size.width,w=i.size.height,c=w,l=p,h=0,a=0,b,k,u;for(n.sort(t);h<n.length;)if(u=n[h],u&&(u.templateResults||u.renderLabel)&&u.width>0&&u.height>0)if(b=p-f-r,k=w-o-r,e(u,f,o,b,k))l=Math.min(f,l),c=Math.min(o,c),s=Math.max(u.height+r,s),f+=u.width+r,a=Math.max(a,f),h++,u.cached=!0;else if(g())a=p;else break;else h++;var d=o+s,v=a-l,y=d-c;return v=v>0?v:0,y=y>0?y:0,{lastAllocatedIndex:h-1,lastRowHeight:s,resumePoint:{x:0,y:d},size:i.size,updatedArea:{x:l,y:c,w:v,h:y}}}function e(n,t,i,r,u){return r>=n.width&&u>=n.height?(n.atlasX=t,n.atlasY=i,!0):!1}function t(n,t){var i=t.height-n.height;return i===0&&(i=t.width-n.width),i}n.build=i}(w||(w={})),function(n){function u(n,i,r,u,f){var s,e,o;if(window.WebGLRenderingContext){for(s={antialias:r,depth:f,premultipliedAlpha:!0,preserveDrawingBuffer:u,stencil:!1,failIfMajorPerformanceCaveat:!i},o=0;o<t.length;o++)if(e=n.getContext(t[o],s),e)return e.enable(e.BLEND),f?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,0),e;throw"WebGL initialization failed";}throw"Browser does not support WebGL";}function f(n){n.clearColor(0,0,0,0);n.clear(n.COLOR_BUFFER_BIT)}function e(n,t,i,r){var u;return u=t?t:n.createBuffer(),n.bindBuffer(i,u),n.bufferData(i,r,n.DYNAMIC_DRAW),u}function o(n,t,i,r,u,f,e,o,s){n.bindBuffer(r,i);n.enableVertexAttribArray(t);n.vertexAttribPointer(t,u,f,e,o,s)}function s(n,t,r){var u;return u=t?t:n.createTexture(),i(n,0,u),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),u}function h(n,t,r,u,f){return t&&(i(n,0,t),n.texSubImage2D(n.TEXTURE_2D,0,r,u,n.RGBA,n.UNSIGNED_BYTE,f)),t}function c(n,t,i){var u=n.createProgram();if(r(n,n.VERTEX_SHADER,t,u),r(n,n.FRAGMENT_SHADER,i,u),n.linkProgram(u),!n.getProgramParameter(u,n.LINK_STATUS))throw n.getProgramInfoLog(u);return u}function l(n,t,i,r,u){return t&&(n.bindBuffer(i,t),n.bufferSubData(i,r,u)),t}function i(n,t,i){n.activeTexture(n.TEXTURE0+t);n.bindTexture(n.TEXTURE_2D,i)}function r(n,t,i,r){var u=n.createShader(t);if(n.shaderSource(u,i),n.compileShader(u),!n.getShaderParameter(u,n.COMPILE_STATUS))throw n.getShaderInfoLog(u);n.attachShader(r,u);n.deleteShader(u)}var t=["webgl","experimental-webgl"];n.createContext=u;n.clear=f;n.uploadBuffer=e;n.readBuffer=o;n.createAndUploadTexture=s;n.updateTexture=h;n.createProgram=c;n.updateBuffer=l}(u||(u={}));nt=function(){function t(n,t,i,r,f,e,o){var s=u.createContext(n[0],f,e||r,o),c=s.getParameter(s.MAX_TEXTURE_SIZE),h;if(!f&&c<8192)throw"Hardware texture size "+c+", does not meet the required texture size of 8192";this._context=s;this._canvas=n;this.updateSize(t);h=u.createProgram(s,v.textureVertex,v.textureFragment);this._program={glProgram:h,a_position:s.getAttribLocation(h,"a_position"),a_texCoord:s.getAttribLocation(h,"a_texCoord"),a_visibleZoom:s.getAttribLocation(h,"a_visibleZoom"),u_PTMatrix:s.getUniformLocation(h,"u_PTMatrix"),u_halfScreen:s.getUniformLocation(h,"u_halfScreen"),u_extrusionScale:s.getUniformLocation(h,"u_extrusionScale"),u_zoom:s.getUniformLocation(h,"u_zoom")};r&&(h=u.createProgram(s,v.solidColorVertex,v.solidColorFragment),this._vectorProgram={glProgram:h,a_position:s.getAttribLocation(h,"a_position"),u_PTMatrix:s.getUniformLocation(h,"u_PTMatrix"),u_halfScreen:s.getUniformLocation(h,"u_halfScreen"),u_color:s.getUniformLocation(h,"u_color")});this._maxTextureSize=i;this._initRenderData()}return t.prototype.render=function(t,i,r,u,f,e,o,s){var p=r&&r.length>0,l=this.currentData,y=u&&u.length>0,w=l&&l.polylines&&l.polylines.length>0,b=l&&l.textures.length>0;if(o=typeof o!="number"||o<=0?n._getDpr():o,b||p||y||w){var k=t.getMercatorZoomLevel(),a=this._context,v=c.getScale(k);l.dpr!==o&&(s=4,this._initRenderData(o));(s===4||s===1)&&this._buildAndUpdateAtlas(a,r,f,0,o);(s===4||s===2||s===3)&&this._buildAndUploadRenderData(a,r,o,v,s);s===4&&(n._clearDisposables(l.polylines),l.polylines=[],l.viewportCenter=null,l.translate=new h(0,0),y&&this._buildVectorEntityData(u,o,v));this._computeTranslate(t,a,v);this.draw(t,e)}},t.prototype._buildVectorEntityData=function(n,t,i){var o=this.currentData,s,e,u,h;for(o.polylines=o.polylines||[],s=0;s<n.length;s++)for(e=n[s].shapes,u=0;u<e.length;u++)if(e[u].type===2&&(h=e[u].points,h)){var f=e[u].style,r,c,l=f.lineCap,a=f.lineJoin,v=f.secondaryLineWidth;v&&(r=tt.parse(f.secondaryStrokeStyle),c={width:v,cap:l,join:a,color:[r.red/255,r.green/255,r.blue/255,r.alpha]},o.polylines.push(new g(this._context,h,c,t,i)));r=tt.parse(f.strokeStyle);c={width:f.lineWidth,cap:l,join:a,color:[r.red/255,r.green/255,r.blue/255,r.alpha]};o.polylines.push(new g(this._context,h,c,t,i))}},t.prototype._computeTranslate=function(n,t,i){var u=0,f=0,e=this._canvas.get_size(),o=e.width/2,s=e.height/2,r;this.currentData.viewportCenter&&(r=n.getMode().tryLocationToPoint(this.currentData.viewportCenter),u=r.x-o,f=s-r.y);var c=this.currentData.translate.x,l=this.currentData.translate.y,a=u/i.pixelScale,v=f/i.pixelScale;c+=a;l+=v;this.currentData.translate.x=c;this.currentData.translate.y=l;this.currentData.viewportCenter=n.getMode().tryPointToLocation(new h(o,s))},t.prototype.updateSize=function(t){var f=this._canvas.get_size(),i=this._context,e=n._getDpr(),r=t.width*e,u=t.height*e;(f.width!==t.width||f.height!==t.height||i.drawingBufferWidth!==r||i.drawingBufferHeight!==u)&&(this._canvas.set_style({width:t.width,height:t.height,left:0,top:0}),i.canvas.width=r,i.canvas.height=u,i.viewport(0,0,r,u))},t.prototype.getCanvas=function(){return this._canvas},t._prepareDraw=function(n,t,i,r){n.useProgram(t.glProgram);n.uniformMatrix4fv(t.u_PTMatrix,!1,i);n.uniform2f(t.u_halfScreen,n.canvas.width/2,n.canvas.height/2);typeof t.u_extrusionScale!="undefined"&&n.uniform1f(t.u_extrusionScale,1);typeof t.u_zoom!="undefined"&&n.uniform1i(t.u_zoom,Math.floor(r))},t._drawTextureEntities=function(n,i,r,f,e,o){var s,h;r.renderedRecords&&(s=r.renderedRecords.length*6,s>0&&(h=20,u.readBuffer(n,i.a_position,r.vertexBuffer,n.ARRAY_BUFFER,4,n.FLOAT,!1,h,0),u.readBuffer(n,i.a_texCoord,r.vertexBuffer,n.ARRAY_BUFFER,2,n.UNSIGNED_SHORT,!0,h,16),u.readBuffer(n,i.a_visibleZoom,r.visibilityBuffer,n.ARRAY_BUFFER,1,n.BYTE,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,r.elementIndexBuffer),t._prepareDraw(n,i,f,o),n.drawElements(n.TRIANGLES,s,n.UNSIGNED_SHORT,0)))},t._drawVectorEntities=function(n,i,r,u,f,e,o){var h,s;if(r.polylines&&(h=r.polylines.length)>0)for(t._prepareDraw(n,i,f,o),s=0;s<h;s++)r.polylines[s].render(i,!u)},t.prototype.draw=function(n,i){var r=this.currentData,f=this._context,e=n.getMercatorZoomLevel(),o=c.getScale(e),s=c.getMatrices(o,f.canvas.width,f.canvas.height,r.translate.x*r.dpr,r.translate.y*r.dpr);u.clear(f);t._drawTextureEntities(f,this._program,r,s,o,e);t._drawVectorEntities(f,this._vectorProgram,r,i,s,o,e)},t.prototype._buildAndUpdateAtlas=function(n,i,r,f,e){var s=this.currentData,o=s.atlas,h,c,a,l;if(t._upsertAtlas(o,i,!1)){if(h=w.build(o,s.maxTextureSize,e),!h&&(t._upsertAtlas(o,i,!0),h=w.build(o,s.maxTextureSize,e),!h&&(o.state=null,s.maxTextureSize*=2,o.context&&o.context.dispose(),o.context=null,t._upsertAtlas(o,i,!0),h=w.build(o,s.maxTextureSize,e),!h)))throw"Too many records to render in WebGL";c=o.state.updatedArea;c.w>0&&c.h>0&&(a=o.context.getRootElement()[0],l=s.textures[f],l&&s.textureSizes[f]===s.maxTextureSize?u.updateTexture(n,l,c.x,c.y,a):(l=s.textures[f]=u.createAndUploadTexture(n,null,a),s.textureSizes[f]=s.maxTextureSize))}},t.prototype._buildAndUploadRenderData=function(n,t,i,r,f){var l=f!==3,e=this._mergeRenderData(t,l),s=e.renderedRecords?e.renderedRecords.length:0,y,ut,p,o,h,ht,ct,w,lt;if(s>0){var at=e.atlas.state.size.width,vt=e.atlas.state.size.height,g=this._canvas.get_size(),yt=g.width/2,pt=g.height/2,nt=r.pixelScale/i,a,v,tt,b,it=0,rt=0;for(l&&(b=new ArrayBuffer(s*80),tt=new DataView(b)),y=new ArrayBuffer(s*Uint8Array.BYTES_PER_ELEMENT*4),ut=new DataView(y),p=0;p<s;p++){if(o=e.renderedRecords[p],l){h=e.atlas.records.getItem(o.id);a=h.width;v=h.height;var ft=o.left+a/2/i,et=o.top+v/2/i,k=ft,d=et,ot=0,st=0;o.anchor&&(k=o.anchor.x,d=o.anchor.y,ot=(k-ft)*i,st=(et-d)*i);ht=(k-yt)/nt;ct=(pt-d)/nt;it=c.fillRectangleData(tt,it,ht,ct,h.atlasX,h.atlasY,a,v,-a/2-ot,-v/2-st,at,vt)}rt=c.fillOneRectangleVisibleZoom(ut,rt,o.visibleZoom)}w=e.visibilityBuffer;l?(e.vertexBuffer=u.uploadBuffer(n,e.vertexBuffer,n.ARRAY_BUFFER,b),w=e.visibilityBuffer=u.uploadBuffer(n,w,n.ARRAY_BUFFER,y),lt=c.buildRectangleVertexIndex(s),e.elementIndexBuffer=u.uploadBuffer(n,e.elementIndexBuffer,n.ELEMENT_ARRAY_BUFFER,lt)):u.updateBuffer(n,w,n.ARRAY_BUFFER,0,y)}},t.prototype._mergeRenderData=function(n,t){var r=this.currentData,e,o,i,f,u;if(t)r.viewportCenter=null,r.translate.x=r.translate.y=0,r.renderedRecords=n;else{for(e={},o=r.renderedRecords,i=0,f=n.length;i<f;i++)n[i].visibleZoom>=0&&(e[n[i].id]=!0);for(i=0,f=o.length;i<f;i++)u=o[i],u.visibleZoom>=0&&u.visibleZoom!==127&&!e[u.id]&&(u.visibleZoom=127)}return r},t.prototype._initRenderData=function(i){var r=this.currentData;i&&r?(r.dpr=i,r.renderedRecords=[],r.atlas=t._emptyAtlas(),r.viewportCenter=null,r.translate=new h(0,0),r.frame=null,n._clearDisposables(r.polylines),r.polylines=[]):this.currentData={textures:[],textureSizes:[],renderedRecords:[],atlas:t._emptyAtlas(),viewportCenter:null,translate:new h(0,0),frame:null,dpr:i||n._getDpr(),maxTextureSize:this._maxTextureSize}},t.prototype.clear=function(){var t=this._context,n=this.currentData,i;if(n.textures&&n.textures.length>0){for(i=0;i<n.textures.length;i++)t.deleteTexture(n.textures[i]);t.deleteBuffer(n.elementIndexBuffer);t.deleteBuffer(n.vertexBuffer);t.deleteBuffer(n.visibilityBuffer)}this._initRenderData();t.clear(t.COLOR_BUFFER_BIT)},t.prototype.dispose=function(){var n=this._context;n&&(this.clear(),this._program&&n.deleteProgram(this._program.glProgram),this._canvas=null,this._program=null,this._context=null)},t._emptyAtlas=function(){return{records:new ct(5e3)}},t._upsertAtlas=function(t,i,r){var c=!1,h=t.records,f,u,e,o,s;if(r&&(h.clear(),t.state=null),i)for(f=0;f<i.length;f++)u=i[f],e=u.id,u.width>0&&u.height>0&&(o=h.getItem(e),o&&o.atlasX!==-1&&o.width!==0||(c=!0,s=n._copyObject(u),s.id=e,r&&(s.cached=!1),h.addItem(e,s)));return c},t}();rt=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return b(t,n),t.prototype._constructVectorLabel=function(){return new ut(this._map)},t}(yt),function(n){function f(n,t,i){return[1,0,0,0,0,1,0,0,0,0,1,0,n,t,i,1,]}function e(n,t,i,r){var u=1/(i-r);return[n/t,0,0,0,0,n,0,0,0,0,(i+r)*u,-1,0,0,i*r*u*2,0]}function o(n,t){var i=n[0],r=n[1],u=n[2],f=n[3],e=n[4],o=n[5],s=n[6],h=n[7],c=n[8],l=n[9],a=n[10],v=n[11],y=n[12],p=n[13],w=n[14],b=n[15],k=t[0],d=t[1],g=t[2],nt=t[3],tt=t[4],it=t[5],rt=t[6],ut=t[7],ft=t[8],et=t[9],ot=t[10],st=t[11],ht=t[12],ct=t[13],lt=t[14],at=t[15];return[k*i+d*e+g*c+nt*y,k*r+d*o+g*l+nt*p,k*u+d*s+g*a+nt*w,k*f+d*h+g*v+nt*b,tt*i+it*e+rt*c+ut*y,tt*r+it*o+rt*l+ut*p,tt*u+it*s+rt*a+ut*w,tt*f+it*h+rt*v+ut*b,ft*i+et*e+ot*c+st*y,ft*r+et*o+ot*l+st*p,ft*u+et*s+ot*a+st*w,ft*f+et*h+ot*v+st*b,ht*i+ct*e+lt*c+at*y,ht*r+ct*o+lt*l+at*p,ht*u+ct*s+lt*a+at*w,ht*f+ct*h+lt*v+at*b,]}function s(n){var u,e=i+.5,f,r;for(f in t)if(t.hasOwnProperty(f)&&(r=parseInt(f),u=r,Math.abs(n-r)<=e)){u=r;break}return u}function h(n){var i=s(n),r=Math.pow(2,n-i),u=r*t[i];return{align:i,pixelScale:u,zoomDelta:r}}function c(n,i,s,h,c){var l=s/2,a=l/r,v=l*u,y=t[n.align],p=e(y,i/s,a,v),w=l/n.zoomDelta,b=f(h,c,-w);return o(p,b)}function l(n,t,i,r,u,f,e,o,s,h,c,l){var a=b(u,f,e,o,c,l),v=w(i,r,e,o,s,h);return y(n,t,{vertices:v,textureLookup:a})}function a(n){for(var u=n*6,i=new Uint16Array(u),r=0,t=0;t<u;t+=6)i[t]=0+r,i[t+1]=1+r,i[t+2]=2+r,i[t+3]=2+r,i[t+4]=1+r,i[t+5]=3+r,r+=4;return i}function v(n,t,i){for(var r=0;r<4;r++)n.setInt8(t,i),t+=Int8Array.BYTES_PER_ELEMENT;return t}function y(n,t,i){for(var r,f=i.vertices,e=i.textureLookup,u=0;u<4;u++){for(r=0;r<4;r++)n.setFloat32(t,f[u*4+r],!0),t+=Float32Array.BYTES_PER_ELEMENT;for(r=0;r<2;r++)n.setUint16(t,e[u*2+r]*65535,!0),t+=Uint16Array.BYTES_PER_ELEMENT}return t}function p(n,t){return[n,0,0,0,n,t,0,t,]}function w(n,t,i,r,u,f){for(var e=[n,t,i,r,n,t,0,r,n,t,i,0,n,t,0,0,],o=0;o<e.length;o+=4)e[o+2]+=u,e[o+3]+=f;return e}function b(n,t,i,r,u,f){for(var e=p(i,r),o=0;o<e.length;o+=2)e[o]=(n+e[o])/u,e[o+1]=(t+e[o+1])/f;return e}var t={"4":.0078125,"11":1,"18":128},i=3,r=2<<i,u=2<<i+2;n.getScale=h;n.getMatrices=c;n.fillRectangleData=l;n.buildRectangleVertexIndex=a;n.fillOneRectangleVisibleZoom=v}(c||(c={}));ut=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return b(t,n),t.prototype._constructRenderers=function(n,t){var i=[];return o.features.taskFramework.glMicroPoi&&!o.glPolyline&&i.push(new d(n,t,"vectorgl",10099,[2])),i.push(new d(n,t,"labelgl",20001,[1])),i},t}(pt);ft=function(t){function i(r,u,f,e){var h=t.call(this,r,null,f,e,i._vectorGLCanvasId,n._getDpr())||this;h._map=u;s.Browser.is_safari&&s(window).add_event("pagehide",function(){h.dispose()});try{h._adapter=new nt(h._canvasElement,h._map.getActualSize(),256,o.glPolyline,o.features.labels.allowSoftwareGL,s.Browser.is_safari,!0);h._disposables.push(h._adapter)}catch(c){console.warn(c);y.glFailure=!0}return h}return b(i,t),i.prototype._setupCanvas=function(i,r){if(!this._canvasElement){var u=n._createElement("canvas");u.add_event("webglcontextlost",function(){y.glFailure=!0},!1);this._canvasElement=s(u)}t.prototype._setupCanvas.call(this,i,r)},i.prototype.transformCanvas=function(){o.glPolyline&&this._adapter&&this._adapter.render(this._map,null,null,null,0,!0,this._dpr,0)},i.prototype.clear=function(){this._adapter.clear()},i.prototype.copyCanvas=function(n){var t=this._canvasElement[0];n.drawImage(t,0,0,t.width,t.height)},i.prototype.setupCanvasStart=function(n){var i=this._adapter.getCanvas().get_size(),t=new it(n.viewport.pixelWidth*1,n.viewport.pixelHeight*1);(i.width!==t.width||i.height!==t.height)&&this._adapter.updateSize(t)},i.prototype._drawTemplateRenderingResults=function(n,t,i,r){var u;if(!r)try{this._adapter.render(this._map,null,t,i,0,!1,this._dpr,4)}catch(f){console.warn(f);this.clear();y.glFailure=!0;u=n}return u},i.prototype._renderIconTemplates=function(n,t,i,r){var u=new st(i.crs,n);return u.project(i.geometry.x,i.geometry.y),p.packGLTemplates(t,this._adapter,this._dpr,r,i,null,1,u.lastProjectedX,u.lastProjectedY)},i.prototype._vectorEntitiesGL=function(){return o.glPolyline&&!y.glFailure},i.prototype._isStyleSupported=function(n){var f=!0,t,i,r,u;if(n)for(t=0;t<n.length;t++){if(i=n[t],i.shapes)for(r=0;r<i.shapes.length;r++)if(u=i.shapes[r].style,u&&u.dashes&&u.dashes.length>0){f=!1;break}if(!f)break}return f},i._vectorGLCanvasId="vectorgl",i}(y);t._LabelControllerGL=rt;t._VectorLayerRendererGL=ft}catch(et){if(f.logger)f.logger.logCriticalError(et);else throw et;}}).call(window)